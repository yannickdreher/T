name: Windows Release

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
    
    - name: Setup MSBuild (Visual Studio)
      uses: microsoft/setup-msbuild@v2
    
    - name: Extract version from tag
      id: version
      shell: pwsh
      run: |
        $tag = "${{ github.event.release.tag_name }}"
        $version = $tag -replace '^v', ''
        $versionParts = $version.Split('.')
        if ($versionParts.Length -eq 3) {
          $version = "$version.0"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "TAG=$tag" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
    
    - name: Update publish profile
      shell: pwsh
      run: |
        $pubxmlPath = "T/Properties/PublishProfiles/win-x64-co.pubxml"
        $version = "${{ steps.version.outputs.VERSION }}"
        $tag = "${{ steps.version.outputs.TAG }}"
        
        $installUrl = "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/$tag/"
        $updateUrl = "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/latest/"
        
        [xml]$pubxml = Get-Content $pubxmlPath
        $pubxml.Project.PropertyGroup.ApplicationVersion = $version
        $pubxml.Project.PropertyGroup.InstallUrl = $installUrl
        $pubxml.Project.PropertyGroup.UpdateUrl = $updateUrl
        
        $pubxml.Save($pubxmlPath)
        echo "Updated ApplicationVersion to: $version"
        echo "Updated InstallUrl to: $installUrl"
        echo "Updated UpdateUrl to: $updateUrl"
    
    - name: Restore dependencies with MSBuild
      shell: pwsh
      run: |
        msbuild T/T.csproj `
          /t:Restore `
          /p:Configuration=Release `
          /p:RuntimeIdentifier=win-x64
    
    - name: Publish
      shell: pwsh
      run: |
        msbuild T/T.csproj `
          /t:Publish `
          /p:PublishProfile=win-x64-co `
          /p:Configuration=Release `
          /p:RuntimeIdentifier=win-x64
    
    - name: Verify
      shell: pwsh
      run: |
        $publishDir = "T/bin/publish"
        echo "Checking publish directory: $publishDir"
        if (Test-Path $publishDir) {
          echo "Contents of publish directory:"
          Get-ChildItem -Path $publishDir | Select-Object Name
        } else {
          echo "ERROR: Publish directory not found!"
          exit 1
        }
    
    - name: Checkout gh-pages branch
      uses: actions/checkout@v4
      with:
        ref: gh-pages
        path: gh-pages
    
    - name: Deploy to GitHub Pages
      shell: pwsh
      run: |
        $publishDir = "T/bin/publish"
        
        $tag = "${{ steps.version.outputs.TAG }}"
        $ghPagesDir = "gh-pages"
        $targetDir = "$ghPagesDir/$tag"
        $latestDir = "$ghPagesDir/latest"
        
        New-Item -ItemType Directory -Path $targetDir -Force
        New-Item -ItemType Directory -Path $latestDir -Force
        
        Copy-Item -Path "$publishDir/*" -Destination $targetDir -Recurse -Force
        Copy-Item -Path "$publishDir/*" -Destination $latestDir -Recurse -Force
        
        echo "Deployed ClickOnce files to: $targetDir and $latestDir"
    
    - name: Commit and push to gh-pages
      shell: pwsh
      working-directory: gh-pages
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add .
        git diff --staged --quiet || git commit -m "Deploy version ${{ steps.version.outputs.TAG }}"
        git push
    
    - name: Create archive
      shell: pwsh
      run: |
        $publishDir = "T/bin/publish"
        Compress-Archive -Path "$publishDir/*" -DestinationPath "windows-x64-clickonce.zip"
    
    - name: Upload archive
      uses: softprops/action-gh-release@v1
      with:
        files: windows-x64-clickonce.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}