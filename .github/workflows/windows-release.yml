name: Windows Release

on:
  release:
    types: [published]

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  publish:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
    
    - name: Setup MSBuild (Visual Studio)
      uses: microsoft/setup-msbuild@v2
    
    - name: Extract version from tag
      id: version
      shell: pwsh
      run: |
        $tag = "${{ github.event.release.tag_name }}"
        $version = $tag -replace '^v', ''
        $versionParts = $version.Split('.')
        if ($versionParts.Length -eq 3) {
          $version = "$version.0"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "TAG=$tag" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
    
    - name: Update publish profile
      shell: pwsh
      run: |
        $pubxmlPath = "T/Properties/PublishProfiles/win-x64-co.pubxml"
        $version = "${{ steps.version.outputs.VERSION }}"
        $tag = "${{ steps.version.outputs.TAG }}"
        
        $baseUrl = "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        $installUrl = "$baseUrl/$tag/"
        $updateUrl = "$baseUrl/latest/"
        
        [xml]$pubxml = Get-Content $pubxmlPath
        $pubxml.Project.PropertyGroup.ApplicationVersion = $version
        $pubxml.Project.PropertyGroup.InstallUrl = $installUrl
        $pubxml.Project.PropertyGroup.UpdateUrl = $updateUrl
        
        $pubxml.Save($pubxmlPath)
        echo "Updated ApplicationVersion to: $version"
        echo "Updated InstallUrl to: $installUrl"
        echo "Updated UpdateUrl to: $updateUrl"
    
    - name: Restore dependencies
      shell: pwsh
      run: |
        msbuild T/T.csproj `
          /t:Restore `
          /p:Configuration=Release `
          /p:RuntimeIdentifier=win-x64
    
    - name: Publish application
      shell: pwsh
      run: |
        msbuild T/T.csproj `
          /t:Publish `
          /p:PublishProfile=win-x64-co `
          /p:Configuration=Release `
          /p:RuntimeIdentifier=win-x64
    
    - name: Verify publish directory
      shell: pwsh
      run: |
        $publishDir = "T/bin/Release/net10.0/win-x64/app.publish"
        echo "Checking publish directory: $publishDir"
        if (Test-Path $publishDir) {
          echo "Contents of publish directory:"
          Get-ChildItem -Path $publishDir | Select-Object Name
        } else {
          echo "ERROR: Publish directory not found!"
          exit 1
        }
    
    - name: Prepare GitHub Pages content
      shell: pwsh
      run: |
        $publishDir = "T/bin/Release/net10.0/win-x64/app.publish"
        $tag = "${{ steps.version.outputs.TAG }}"
        $pagesDir = "pages-content"
        $targetDir = "$pagesDir/$tag"
        $latestDir = "$pagesDir/latest"
        
        New-Item -ItemType Directory -Path $targetDir -Force
        New-Item -ItemType Directory -Path $latestDir -Force
        
        Copy-Item -Path "$publishDir/*" -Destination $targetDir -Recurse -Force
        Copy-Item -Path "$publishDir/*" -Destination $latestDir -Recurse -Force
        
        echo "Prepared Pages content structure:"
        Get-ChildItem -Path $pagesDir -Recurse -Directory | Select-Object FullName
    
    - name: Setup Pages
      uses: actions/configure-pages@v5
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: 'pages-content'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: Create archive
      shell: pwsh
      run: |
        $publishDir = "T/bin/Release/net10.0/win-x64/app.publish"
        Compress-Archive -Path "$publishDir/*" -DestinationPath "windows-x64-clickonce.zip"
    
    - name: Upload archive
      uses: softprops/action-gh-release@v1
      with:
        files: windows-x64-clickonce.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}