name: Windows Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  publish:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
    
    - name: Extract version from tag
      id: version
      shell: pwsh
      run: |
        $tag = "${{ github.event.release.tag_name }}"
        $version = $tag -replace '^v', ''
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "TAG=$tag" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
    
    - name: Install Velopack
      shell: pwsh
      run: |
        dotnet tool install -g vpk
    
    - name: Restore dependencies
      shell: pwsh
      run: |
        dotnet restore T/T.csproj
    
    - name: Publish application
      shell: pwsh
      run: |
        dotnet publish T/T.csproj `
          -c Release `
          -r win-x64 `
          --self-contained `
          -p:Version=${{ steps.version.outputs.VERSION }} `
          -o publish/
    
    - name: Package with Velopack
      shell: pwsh
      run: |
        vpk pack `
          -u T `
          -v ${{ steps.version.outputs.VERSION }} `
          -p publish/ `
          -e T.exe `
          -i T/Assets/logo.ico `
          -s T/Assets/logo.svg `
          -o releases/ `
          --packTitle "T" `
          --packAuthors "The T Project Contributors"
    
    - name: Upload Release Assets
      uses: softprops/action-gh-release@v2
      with:
        files: |
          releases/*.exe
          releases/RELEASES
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}