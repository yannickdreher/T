name: Windows Release

on:
  release:
    types: [published]

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  publish:
    runs-on: windows-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json', '**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
    
    - name: Install Visual Studio 2026 Build Tools
      shell: pwsh
      run: |
        Write-Host "Installing Visual Studio 2026 Build Tools with MSBuild 18..."
        
        choco install visualstudio2026buildtools `
          --package-parameters "--add Microsoft.VisualStudio.Workload.MSBuildTools --add Microsoft.VisualStudio.Workload.NetCoreTools --add Microsoft.NetCore.Component.SDK --add Microsoft.VisualStudio.Component.ClickOnce.MSBuild --add Microsoft.VisualStudio.Component.ClickOnce.Publish --quiet --norestart --wait" `
          --yes --no-progress
        
        Write-Host "✓ Visual Studio 2026 Build Tools installed"
    
    - name: Setup MSBuild 18
      shell: pwsh
      run: |
        Write-Host "Searching for MSBuild installations..."
        
        $possiblePaths = @(
        "C:\Program Files\Microsoft Visual Studio\18\Community\MSBuild\Current\Bin",
          "C:\Program Files (x86)\Microsoft Visual Studio\18\Community\MSBuild\Current\Bin",
          "C:\Program Files\Microsoft Visual Studio\18\Professional\MSBuild\Current\Bin",
          "C:\Program Files (x86)\Microsoft Visual Studio\18\Professional\MSBuild\Current\Bin",
          "C:\Program Files\Microsoft Visual Studio\18\BuildTools\MSBuild\Current\Bin",
          "C:\Program Files (x86)\Microsoft Visual Studio\18\BuildTools\MSBuild\Current\Bin",
          "C:\Program Files\Microsoft Visual Studio\2026\BuildTools\MSBuild\Current\Bin",
          "C:\Program Files (x86)\Microsoft Visual Studio\2026\BuildTools\MSBuild\Current\Bin",
          "C:\Program Files\Microsoft Visual Studio\2026\Enterprise\MSBuild\Current\Bin",
          "C:\Program Files (x86)\Microsoft Visual Studio\2026\Enterprise\MSBuild\Current\Bin"
        )
        
        Write-Host "`n=== Checking predefined paths ==="
        foreach ($path in $possiblePaths) {
          if (Test-Path "$path\MSBuild.exe") {
            Write-Host "✓ FOUND: $path"
          } else {
            Write-Host "✗ Not found: $path"
          }
        }
        
        Write-Host "`n=== Searching all Visual Studio installations ==="
        $vsWhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
        if (Test-Path $vsWhere) {
          $installations = & $vsWhere -all -prerelease -format json | ConvertFrom-Json
          foreach ($install in $installations) {
            Write-Host "Found VS Installation:"
            Write-Host "  Display Name: $($install.displayName)"
            Write-Host "  Version: $($install.installationVersion)"
            Write-Host "  Path: $($install.installationPath)"
            
            $msbuildPath = Join-Path $install.installationPath "MSBuild\Current\Bin"
            if (Test-Path "$msbuildPath\MSBuild.exe") {
              Write-Host "  ✓ MSBuild found at: $msbuildPath"
            }
          }
        } else {
          Write-Host "vswhere.exe not found"
        }
        
        Write-Host "`n=== Recursive search for MSBuild.exe ==="
        $drives = @("C:\Program Files", "C:\Program Files (x86)")
        foreach ($drive in $drives) {
          if (Test-Path $drive) {
            Get-ChildItem -Path $drive -Filter "MSBuild.exe" -Recurse -ErrorAction SilentlyContinue | 
              Select-Object -First 10 | 
              ForEach-Object { Write-Host "Found: $($_.FullName)" }
          }
        }
        
        Write-Host "`n=== Attempting to add MSBuild to PATH ==="
        $msbuildPath = $null
        foreach ($path in $possiblePaths) {
          if (Test-Path "$path\MSBuild.exe") {
            $msbuildPath = $path
            break
          }
        }
        
        if ($null -eq $msbuildPath -and (Test-Path $vsWhere)) {
          $installation = & $vsWhere -latest -prerelease -products * -requires Microsoft.Component.MSBuild -find MSBuild\**\Bin\MSBuild.exe | Select-Object -First 1
          if ($installation) {
            $msbuildPath = Split-Path -Parent $installation
          }
        }
        
        if ($null -ne $msbuildPath -and (Test-Path "$msbuildPath\MSBuild.exe")) {
          echo "$msbuildPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          Write-Host "`n✓ MSBuild 18 added to PATH: $msbuildPath"
          & "$msbuildPath\MSBuild.exe" -version
        } else {
          Write-Host "`n✗ ERROR: MSBuild not found!"
          exit 1
        }
    
    - name: Extract version from tag
      id: version
      shell: pwsh
      run: |
        $tag = "${{ github.event.release.tag_name }}"
        $version = $tag -replace '^v', ''
        $versionParts = $version.Split('.')

        if ($versionParts.Length -eq 3)
        {
          $version = "$version.0"
        }

        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "TAG=$tag" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
    
    - name: Update publish profile
      shell: pwsh
      run: |
        $pubxmlPath = "T/Properties/PublishProfiles/win-x64-co.pubxml"
        $version = "${{ steps.version.outputs.VERSION }}"
        $tag = "${{ steps.version.outputs.TAG }}"
        
        $baseUrl = "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        $installUrl = "$baseUrl/$tag/"
        $updateUrl = "$baseUrl/"
        
        [xml]$pubxml = Get-Content $pubxmlPath
        $pubxml.Project.PropertyGroup.ApplicationVersion = $version
        $pubxml.Project.PropertyGroup.InstallUrl = $installUrl
        $pubxml.Project.PropertyGroup.UpdateUrl = $updateUrl
        
        $pubxml.Save($pubxmlPath)
        echo "Updated ApplicationVersion to: $version"
        echo "Updated InstallUrl to: $installUrl"
        echo "Updated UpdateUrl to: $updateUrl"
    
    - name: Restore dependencies
      shell: pwsh
      run: |
        msbuild T/T.csproj `
          /t:Restore `
          /p:Configuration=Release `
          /p:RuntimeIdentifier=win-x64
    
    - name: Publish application
      shell: pwsh
      run: |
        msbuild T/T.csproj `
          /t:Publish `
          /p:PublishProfile=win-x64-co `
          /p:Configuration=Release `
          /p:RuntimeIdentifier=win-x64
    
    - name: Verify publish directory
      shell: pwsh
      run: |
        $publishDir = "T/bin/Publish"
        echo "Checking publish directory: $publishDir"
        if (Test-Path $publishDir)
        {
          echo "✓ Contents of publish directory:"
          Get-ChildItem -Path $publishDir -Recurse -File | Select-Object FullName
        }
        else
        {
          echo "ERROR: No publish directory found!"
          exit 1
        }
        
        if (-not $env:PUBLISH_DIR) {
          echo "PUBLISH_DIR=$publishDir" >> $env:GITHUB_ENV
        }
    
    - name: Prepare GitHub Pages content
      shell: pwsh
      run: |
        $publishDir = $env:PUBLISH_DIR
        $tag = "${{ steps.version.outputs.TAG }}"
        $pagesDir = "pages-content"
        $targetDir = "$pagesDir/$tag"
        
        New-Item -ItemType Directory -Path $targetDir -Force
        
        Copy-Item -Path "$publishDir/*" -Destination $targetDir -Recurse -Force
        Copy-Item -Path "$publishDir/*" -Destination $pagesDir -Recurse -Force
        
        echo "✓ Deployed ClickOnce files:"
        echo "  - Version-specific: /$tag/"
        echo "  - Latest (root): /"
    
    - name: Setup Pages
      uses: actions/configure-pages@v5
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: 'pages-content'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: Create archive
      shell: pwsh
      run: |
        $publishDir = $env:PUBLISH_DIR
        Compress-Archive -Path "$publishDir/*" -DestinationPath "windows-x64-clickonce.zip"
    
    - name: Upload archive
      uses: softprops/action-gh-release@v1
      with:
        files: windows-x64-clickonce.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}